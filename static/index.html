<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>大文件上传</title>
</head>
<body>
<div>this is test file</div>
<form action="/upload" method="post" enctype="multipart/form-data">
  file: <input type="file" id="file" name="file"/>
  <input type="submit" value="submit">
</form>
<button id="pause">暂停</button>
<br/>
校验进度：<span id="progress">请选择文件...</span><br/>
上传进度：<span id="uploadProgress">等待校验完成...</span>
<script src="./spark-md5.js"></script>
<script src="./axios.js"></script>
<script type="text/javascript">
  let fileElement = document.querySelector('#file')
  let progress = document.querySelector('#progress')
  let uploadProgress = document.querySelector('#uploadProgress')
  let pause = document.querySelector('#pause')
  let stop = false
  fileElement.addEventListener('change', function () {
    let file = fileElement.files[0]
    let chunkSize = 1024 * 1024 * 2
    let chunks = Math.ceil(file.size / chunkSize)
    let currentChunk = 0
    let spark = new SparkMD5.ArrayBuffer()
    let fileReader = new FileReader()

    fileReader.onerror = function () {
      console.warn('oops, something went wrong.');
    };
    fileReader.onload = function (e) {
      console.log('read chunk nr', currentChunk + 1, 'of', chunks);
      progress.innerHTML = (((currentChunk + 1) / chunks) * 100).toFixed(2) + '%'
      spark.append(e.target.result);                   // Append array buffer
      currentChunk++;

      if (currentChunk < chunks) {
        loadNext();
      } else {
        let md5 = spark.end()
        axios.post('/checkFile', {md5}).then(function ({data}) {
          if (data.status === true) {
            doUpload(file, chunks, chunkSize, md5, data.current)
          } else {
            uploadProgress.innerHTML = '秒传成功!'
          }
        })
        pause.addEventListener('click', function () {
          if (stop) {
            // 继续
            axios.post('/checkFile', {md5}).then(function ({data}) {
              if (data.status === true) {
                doUpload(file, chunks, chunkSize, md5, data.current)
              } else {
                uploadProgress.innerHTML = '秒传成功!'
              }
            })
          }
          stop = !stop
          pause.innerHTML = stop ? '继续' : '暂停'
        })
      }
    };

    function loadNext() {
      let start = currentChunk * chunkSize
      let end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;
      fileReader.readAsArrayBuffer(file.slice(start, end))
      console.log(file.slice(start, end))
    }

    function doUpload(file, total, chunkSize, md5, current) {
      uploadChunk(createFormData({
        md5, total, current,
        file: file.slice(current * chunkSize, ((current * chunkSize + chunkSize) >= file.size) ? file.size : current * chunkSize + chunkSize)
      }))
      function uploadChunk(params) {
        if (stop) {
          return
        }
        return axios.post('/uploadChunk', params).then(function ({data}) {
          console.log('network:', data)
          let current = data.current
          uploadProgress.innerHTML = (((current) / total) * 100).toFixed(2) + '%'
          console.log(current, total)
          if (current < total) {
            uploadChunk(createFormData({
              md5, total, current,
              file: file.slice(current * chunkSize, ((current * chunkSize + chunkSize) >= file.size) ? file.size : current * chunkSize + chunkSize)
            }))
          } else {
            axios.post('/finishUpload', {
              name: file.name,
              total,
              md5
            }).then(function ({data}) {
              if (data.status === true) {
                uploadProgress.innerHTML = data.data
              }
            })
          }
        })
      }
    }

    function createFormData(params) {
      let formData = new FormData()
      for (let key in params) {
        formData.append(key, params[key])
      }
      return formData
    }

    loadNext();
  })
</script>
</body>
</html>